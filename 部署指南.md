# GPU 监控 Notion 部署指南

## 一、整体流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  server01   │     │  server02   │     │  其他服务器  │
│  监控脚本   │     │  监控脚本   │     │  监控脚本   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │   每 2–5 分钟     │                   │
       └───────────────────┼───────────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │ Notion API  │
                   │  推送数据   │
                   └──────┬──────┘
                          │
                          ▼
                   ┌─────────────┐
                   │ Notion 数据库│
                   │  GPU 状态   │
                   └─────────────┘
```

---

## 二、下一步要做的事（按顺序）

### 第一步：在 Notion 创建数据库

1. 新建一个 Notion 页面，例如「GPU 运行状态」
2. 在页面内创建 **Database - Table**（表格数据库）
3. 添加以下列（属性）：

| 列名 | 类型 | 说明 |
|------|------|------|
| 服务器 | Text | 如 server01、server02 |
| GPU | Text | 如 GPU 0 · RTX 4090 |
| 显存占用 | Text | 如 23475 / 24564 MiB (96%) |
| 利用率 | Number | 0–100 |
| 状态 | Select | 闲置 / 运行中 / 占满 |
| 占用用户 | Text | 如 gdtest |
| 进程 | Text | 如 VLLM::Worker_TP0 |
| 更新时间 | Date | 自动或手动 |

4. 将该数据库 **分享给 Notion Integration**（下一步创建）

---

### 第二步：创建 Notion Integration 并获取 API Key

1. 打开 https://www.notion.so/my-integrations
2. 点击 **+ New integration**
3. 填写名称（如「GPU Monitor」），选择 Workspace
4. 创建后复制 **Internal Integration Token**（即 API Key，形如 `secret_xxx`）
5. 回到 Notion 数据库页面 → 右上角 **···** → **Connections** → 添加刚创建的 Integration

---

### 第三步：获取数据库 ID

1. 在 Notion 中打开该数据库页面
2. 浏览器地址栏 URL 形如：`https://www.notion.so/xxx?v=yyy`
3. 其中 `xxx` 即为数据库 ID（32 位，可能含 `-`）
4. 若 URL 为 `https://www.notion.so/workspace/abc123def456...`，则数据库 ID 为 `abc123def456...`（去掉 `workspace/` 前缀）

---

### 第四步：在每台服务器部署监控脚本

每台需要监控的服务器（server01、server02 等）都需要：

1. **复制脚本到服务器**
   - `gpu_monitor_json.sh`（采集 GPU 数据）
   - `push_to_notion.py`（推送到 Notion，待创建）

2. **配置环境**
   - 安装 Python 3
   - 安装依赖：`pip install requests`（用于调用 Notion API）

3. **配置密钥**
   - 在脚本中填入 `NOTION_API_KEY` 和 `NOTION_DATABASE_ID`
   - 或通过环境变量传入（更安全）

4. **配置定时任务**
   - 使用 cron，每 2–5 分钟执行一次
   - 例如：`*/3 * * * * /path/to/run_monitor.sh`

---

### 第五步：设置 Notion 页面权限

1. 在 Notion 中打开「GPU 运行状态」页面
2. 点击右上角 **Share**
3. 仅邀请实验室成员，不公开分享

---

## 三、当前已有 / 待创建的文件

| 文件 | 状态 | 说明 |
|------|------|------|
| `scripts/gpu_monitor_json.sh` | ✅ 已有 | 采集 GPU 数据并输出 JSON |
| `scripts/push_to_notion.py` | ⏳ 待创建 | 读取 JSON，调用 Notion API 推送 |
| `scripts/run_monitor.sh` | ⏳ 待创建 | 串联采集 + 推送，供 cron 调用 |

---

## 四、你需要提供的信息

在继续写 `push_to_notion.py` 之前，请准备好：

1. **Notion 数据库 ID**（完成第一步、第三步后可得）
2. **Notion Integration Token**（完成第二步后可得）
3. **服务器 hostname**（如 server01、server02），用于在脚本中标识每台机器

---

## 五、建议执行顺序

1. 先在 Notion 建好数据库，拿到 Database ID 和 Integration Token  
2. 我根据这些信息写好 `push_to_notion.py` 和 `run_monitor.sh`  
3. 你在 server01 上试跑一次，确认数据能正确写入 Notion  
4. 再在 server02 及其他服务器上按同样方式部署  

完成 Notion 配置后，把 Database ID 和 Token（可打码部分字符）发给我，我就可以写出完整的推送脚本。
